// Backbone.Minionette
// -------------------
// v0.1.0
//
// Copyright (c)2013 Justin Ridgewell
// Distributed under MIT license
//
// https://github.com/jridgewell/minionette

(function(e,t){if("object"==typeof exports){var i=require("underscore"),n=require("jquery"),s=require("backbone");module.exports=t(i,n,s)}else"function"==typeof define&&define.amd&&define(["underscore","jquery","backbone"],t)})(this,function(e,t,i){return function(e,t,i,n){"use strict";var s={};return n.Minionette=s,i.event.special.remove={remove:function(e){e.handler&&e.handler()}},s.View=n.View.extend({constructor:function(){n.View.apply(this,arguments),t.bindAll(this,"_jquery_remove"),this._subViews={},this._bindEntityEvents(this,this.model,this.modelEvents),this._bindEntityEvents(this,this.collection,this.collectionEvents)},template:function(){return""},delegateEvents:function(e){n.View.prototype.delegateEvents.apply(this,e),this.$el.on("remove.delegateEvents"+this.cid,this._jquery_remove)},close:function(){t.each(this._subViews,function(e){e.close()}),this.remove()},assign:function(e,i,n){var s;t.isObject(e)?(s=e,n=i):(s={},s[e]=i),s&&t.each(s,function(e,t){this._subViews[e.cid]=e,n?this.$(t).replaceWith(e.el):e.setElement(this.$(t)).render()},this)},_jquery_remove:function(){this.close()},_bindEntityEvents:function(e,i,n){for(var s in n){var o=n[s];t.isFunction(o)||(o=this[o]),o&&e.listenTo(i,s,o)}return this}}),s.ModelView=s.View.extend({serializeData:function(){return this.model.attributes},render:function(){return t.each(this._subViews,function(e){e.$el.detach()}),this.$el.html(this.template(this.serializeData())),this.attachSubViews(),this},attachSubViews:function(){}}),s.CollectionView=s.View.extend({constructor:function(){s.View.apply(this,arguments),this._listenEvents()},setElement:function(){s.View.prototype.setElement.apply(this,arguments),this.$whereToAdd=this.$(this.options.whereToAdd)[0]||this.$(this.whereToAdd)[0]||this.$el},render:function(){this.$el.html(this.template(this.collection));var e=this._getModelView();return this.collection.each(function(t){this._addModelView(t,e)},this),this},addOne:function(e){var t=this._getModelView();this._addModelView(e,t)},removeOne:function(e){var t=this._findSubViewByModel(e);this._removeModelView(t)},_addModelView:function(e,t){var i=new t({model:e});this._subViews[i.cid]=i,this.$whereToAdd.append(i.render().el)},_getModelView:function(){var e=this.ModelView;return this.options&&this.options.ModelView&&(e=this.option.ModelView),e},_listenEvents:function(){this.collection&&(this.listenTo(this.collection,"add",this.addOne,this),this.listenTo(this.collection,"remove",this.removeOne,this),this.listenTo(this.collection,"reset",this.render,this))},_removeModelView:function(e){e&&(e.close(),delete this._subViews[e.cid])},_findSubViewByModel:function(e){return t.findWhere(this._subViews,{model:e})}}),s}(this,e,t,i),i.Minionette});