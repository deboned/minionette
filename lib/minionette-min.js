// Backbone.Minionette
// -------------------
// v1.3.2
//
// Copyright (c)2013 Justin Ridgewell
// Distributed under MIT license
//
// https://github.com/jridgewell/minionette

"use strict";var Minionette=function(a,b){function c(b,c){if(null==b)return void 0;var d=a.rest(arguments,2);return a.isFunction(b[c])?b[c].apply(b,d):void 0}function d(c){return a.result(c._parent,"$el")||b.$()}var e=b.Minionette={};return e.View=b.View.extend({constructor:function(c){c=c||{},this._ensureRegion(c),this._initializeRegions(c),b.View.apply(this,arguments),this._listenToEvents(this.model,a.result(this,"modelEvents")),this._listenToEvents(this.collection,a.result(this,"collectionEvents")),a.bindAll(this,"_viewHelper")},template:function(){return""},serialize:function(){return{}},_serialize:function(){return a.extend({view:this._viewHelper},this.serialize())},remove:function(){this.trigger("remove",this),this._removeFromParent(),a.invoke(this._regions,"remove"),e.View.__super__.remove.apply(this,arguments),this.trigger("removed",this),this.unbind()},render:function(){return this.trigger("render",this),a.invoke(this._regions,"detach"),this.$el.html(this.template(this._serialize())),a.invoke(this._regions,"reattach"),this.trigger("rendered",this),this},addRegion:function(a,b){c(this._regions[a],"remove");var d={name:a};!b||b.$el?d.view=b:(d.el=this.$(b),d.el.selector=b.selector||b);var e=new this.Region(d);return e._parent=this,this[e.cid]=this._regions[e.cid]=e,e},addRegions:function(b){a.each(b,function(a,b){this.addRegion(b,a)},this)},_removeFromParent:function(){c(this._parent,"_removeView",this)},_removeRegion:function(a){delete this[a.cid],delete this._regions[a.cid]},_listenToEvents:function(b,c){b&&a.each(c,function(c,d){a.isFunction(c)||(c=this[c]),this.listenTo(b,d,c)},this)},_ensureRegion:function(a){this.Region=a.Region||this.Region||e.Region},_initializeRegions:function(b){this._regions={};var c=a.result(b,"regions")||a.result(this,"regions");this.addRegions(c)},_viewHelper:function(a){var b=this._regions[a];return b&&b.render().el?b.view.el.outerHTML:""}}),e.Region=function(b){b=b||{},this.cid=b.name||a.uniqueId("region"),this._ensureView(b)},e.Region.extend=b.View.extend,a.extend(e.Region.prototype,b.Events,{_ensureView:function(a){var c={el:a.el,tagName:"span",attributes:function(){return{"data-cid":this.cid}}};this._view=new b.View(c),this._view.$el.selector=this._view.$el.selector||"[data-cid="+this._view.cid+"]",this.view=a.view||this._view,this.view._parent=this},_ensureElement:function(a){var b=d(this),c=a.$el.selector;a.setElement(b.find(c))},reset:function(a){this.attach(this._view,a)},render:function(){return this.view.render()},attach:function(a,b){var d=this.view;return c(this._detachedView,"remove"),delete this._detachedView,this.view=a,a._parent=this,a.el!==d.el&&(d.$el.parent().length&&(d.$el.after(a.$el),d.$el.detach()),b||d.remove()),a},remove:function(){this.trigger("remove",this),this._removeViews(),this._removeFromParent(),this.stopListening()},_removeViews:function(){this.view.remove(),this._view.remove(),c(this._detachedView,"remove")},_removeFromParent:function(){c(this._parent,"_removeRegion",this)},detach:function(){var a=this.view;return a!==this._view&&(this.reset(!0),this._detachedView=a),this},reattach:function(){if(this._view.el||this._ensureElement(this._view),this._detachedView||this.view===this._view){var a=d(this),b=this.view.$el.selector,c=a.find(b),e=this._detachedView||this._view;if(c[0]!==e.el)return c.replaceWith(e.$el),delete this._detachedView,this.view=e,e}},_removeView:function(a){this.view===a&&this.reset(!0)}}),e.ModelView=e.View.extend({modelEvents:{change:"render",destroy:"remove"},serialize:function(){return this.model.attributes}}),e.CollectionView=e.View.extend({constructor:function(a){this._modelViews={},this._modelViewModels={},this._ensureModelView(a||{}),e.View.apply(this,arguments),this.on("rendered",this._renderModelViews),this.on("remove",this._removeModelViews)},collectionEvents:{add:"addOne",remove:"removeOne",reset:"render",sort:"render"},render:function(){return this.once("render",this._removeModelViews),e.CollectionView.__super__.render.apply(this)},_renderModelViews:function(){var a=document.createDocumentFragment(),b=this.appendHtml;this.appendHtml=function(b){a.appendChild(b[0])},this.collection.each(this.addOne,this),this.appendHtml=b,this.appendHtml(a)},appendHtml:function(a){this.$el.append(a)},addOne:function(a){var b=new this.ModelView({model:a});return this._modelViews[b.cid]=b,this._modelViewModels[a.cid]=b,b._parent=this,this.trigger("addOne",b,this),this.appendHtml(b.render().$el),this.trigger("addedOne",b,this),b},removeOne:function(a){var b=this._modelViewModels[a.cid];return b&&(this.trigger("removeOne",b,this),b.remove(),this.trigger("removedOne",b,this)),b},_removeView:function(a){delete this._modelViews[a.cid],delete this._modelViewModels[a.model.cid]},_removeModelViews:function(){this.$el.empty(),a.invoke(this._modelViews,"remove")},_ensureModelView:function(a){this.ModelView=a.ModelView||this.ModelView||e.ModelView}}),e}(_,Backbone);