// Backbone.Minionette
// -------------------
// v1.5.1
//
// Copyright (c)2013 Justin Ridgewell
// Distributed under MIT license
//
// https://github.com/jridgewell/minionette

"use strict";var Minionette=function(a,b){function c(b,c){if(null==b)return void 0;var d=a.rest(arguments,2);return a.isFunction(b[c])?b[c].apply(b,d):void 0}function d(c){return a.result(c._parent,"$el")||b.$()}var e=b.Minionette={};return e.View=b.View.extend({constructor:function(c){a.extend(this,a.pick(c||{},"regions","Region","template")),this._initializeRegions(),b.View.apply(this,arguments),this._listenToEvents(this.model,a.result(this,"modelEvents")),this._listenToEvents(this.collection,a.result(this,"collectionEvents")),a.bindAll(this,"_viewHelper")},template:function(){return""},serialize:function(){return{}},_serialize:function(){return a.extend({view:this._viewHelper},this.serialize())},remove:function(){this.trigger("remove",this),this._removeFromParent(),a.invoke(this._regions,"remove"),e.View.__super__.remove.apply(this,arguments),this.trigger("removed",this),this.unbind()},render:function(){return this.trigger("render",this),a.invoke(this._regions,"detach"),this.$el.html(this.template(this._serialize())),a.invoke(this._regions,"reattach"),this.trigger("rendered",this),this},addRegion:function(a,b){c(this._regions[a],"remove");var d={cid:a};!b||b.$el?d.view=b:(d.el=this.$(b),d.el.selector=b.selector||b);var e=new this.Region(d);return e._parent=this,this[e.cid]=this._regions[e.cid]=e,e},addRegions:function(b){a.each(b,function(a,b){this.addRegion(b,a)},this)},_removeFromParent:function(){c(this._parent,"_removeView",this)},_removeRegion:function(a){delete this[a.cid],delete this._regions[a.cid]},_listenToEvents:function(b,c){b&&a.each(c,function(c,d){a.isFunction(c)||(c=this[c]),this.listenTo(b,d,c)},this)},_initializeRegions:function(){this._regions={},this.Region=this.Region||e.Region,this.addRegions(a.result(this,"regions"))},_viewHelper:function(a){var b,c=this._regions[a];return c&&(b=c.render().el)?b.outerHTML:""}}),e.Region=function(b){b=b||{},this.cid=b.cid||a.uniqueId("region"),this._ensureView(b)},e.Region.extend=b.View.extend,a.extend(e.Region.prototype,b.Events,{_ensureView:function(a){var c={el:a.el,tagName:"span",attributes:function(){return{"data-cid":this.cid}}};this._view=new b.View(c),this._view.$el.selector=this._view.$el.selector||"[data-cid="+this._view.cid+"]",this.view=a.view||this._view,this.view._parent=this},_ensureElement:function(a){var b,c=d(this),e=a.$el.selector;a.$el.parent().is(c)||(b=c.find(e),b.selector=e,a.setElement(b))},reset:function(a){this.attach(this._view,a)},render:function(){return this.view.render()},attach:function(a,b){var d=this.view,e=d.$el;return this.trigger("attach",a,this),this.view=a,a._parent=this,c(this._detachedView,"remove"),delete this._detachedView,d.$el.is(a.$el)||(e.parent().length&&(e.after(a.$el),e.detach()),b||d.remove()),this.trigger("attached",a,this),a},remove:function(){this.trigger("remove",this),this._removeViews(),this._removeFromParent(),this.stopListening(),this.trigger("removed",this),this.unbind()},_removeViews:function(){this.view.remove(),this._view.remove(),c(this._detachedView,"remove")},_removeFromParent:function(){c(this._parent,"_removeRegion",this)},detach:function(){var a=this.view;return a!==this._view&&(this.trigger("detach",a,this),this.reset(!0),this._detachedView=a,this.trigger("detached",a,this)),this},reattach:function(){if(this._ensureElement(this._view),this._detachedView){var a=this._detachedView;delete this._detachedView,this.trigger("reattach",a,this);var b=this.attach(a,!0);return this.trigger("reattached",b,this),b}},_removeView:function(a){this.view===a&&this.reset(!0)}}),e.ModelView=e.View.extend({modelEvents:{change:"render",destroy:"remove"},serialize:function(){return this.model.attributes}}),e.CollectionView=e.View.extend({constructor:function(a){this._modelViews={},this._modelViewModels={},this._ensureModelView(a||{}),e.View.apply(this,arguments),this.on("rendered",this._renderModelViews),this.on("removed",this._removeModelViews)},collectionEvents:{add:"addOne",remove:"removeOne",reset:"render",sort:"render"},modelViewEventPrefix:"modelView",render:function(){return this.once("render",this._removeModelViews),e.CollectionView.__super__.render.apply(this)},_renderModelViews:function(){var a=$(document.createDocumentFragment()),b=this.appendHtml;this.appendHtml=function(b){a.append(b)},this.collection.each(this.addOne,this),this.appendHtml=b,this.appendHtml(a)},appendHtml:function(a){this.$el.append(a)},addOne:function(a){var b=this.buildModelView(a);return this._forwardEvents(b),this._modelViews[b.cid]=b,this._modelViewModels[a.cid]=b,b._parent=this,this.trigger("addOne",b,this),this.appendHtml(b.render().$el),this.trigger("addedOne",b,this),b},buildModelView:function(a){return new this.ModelView({model:a})},removeOne:function(a){var b=this._modelViewModels[a.cid];return b&&(this.trigger("removeOne",b,this),b.remove(),this.trigger("removedOne",b,this),this.stopListening(b)),b},_removeView:function(a){delete this._modelViews[a.cid],delete this._modelViewModels[a.model.cid]},_removeModelViews:function(){this.$el.empty(),a.invoke(this._modelViews,"remove")},_ensureModelView:function(b){var c=b.ModelView||this.ModelView||{};a.isFunction(c)||(c=e.ModelView.extend(c)),this.ModelView=c},_forwardEvents:function(b){this.listenTo(b,"all",function(){var c=a.toArray(arguments),d=a.result(this,"modelViewEventPrefix");d=d?d+":":"",c[0]=d+c[0],c.push(b),this.trigger.apply(this,c)})}}),e}(_,Backbone);