// Backbone.Minionette
// -------------------
// v1.1.4
//
// Copyright (c)2013 Justin Ridgewell
// Distributed under MIT license
//
// https://github.com/jridgewell/minionette

var Minionette=function(a,b,c,d){"use strict";function e(a,c){if(null==a)return void 0;var d=b.rest(arguments,2);return b.isFunction(a[c])?a[c].apply(a,d):void 0}function f(a){return b.result(a._parent,"$el")||d.$()}var g={};return d.Minionette=g,g.View=d.View.extend({constructor:function(a){a=a||{},this._ensureRegion(a),this._initializeRegions(a),d.View.apply(this,arguments),this._listenToEvents(this.model,b.result(this,"modelEvents")),this._listenToEvents(this.collection,b.result(this,"collectionEvents")),b.bindAll(this,"_viewHelper")},template:function(){return""},serialize:function(){return{}},_serialize:function(){return b.extend({view:this._viewHelper},this.serialize())},remove:function(){this._isRemoving||(this._isRemoving=!0,this.trigger("remove",this),this._removeFromParent(),b.invoke(this._regions,"remove"),g.View.__super__.remove.apply(this,arguments),this.trigger("removed",this),this.unbind())},render:function(){return this.trigger("render",this),b.invoke(this._regions,"detach"),this.$el.html(this.template(this._serialize())),b.invoke(this._regions,"reattach"),this.trigger("rendered",this),this},addRegion:function(a,c){e(this._regions[a],"remove");var d={name:a};b.isString(c)?(d.el=this.$(c),d.el.selector=c):d.view=c;var f=new this.Region(d);return f._parent=this,this[a]=this._regions[a]=f,f},addRegions:function(a){b.each(a,function(a,b){this.addRegion(b,a)},this)},_removeFromParent:function(){e(this._parent,"_removeView",this)},_removeRegion:function(a){delete this[a.cid],delete this._regions[a.cid]},_listenToEvents:function(a,c){a&&b.each(c,function(c,d){b.isFunction(c)||(c=this[c]),this.listenTo(a,d,c)},this)},_ensureRegion:function(a){this.Region=a.Region||this.Region||g.Region},_initializeRegions:function(a){this._regions={};var c=b.result(a,"regions")||b.result(this,"regions");this.addRegions(c)},_viewHelper:function(a){var b=this._regions[a];return b&&b.render().el?b.view.el.outerHTML:""}}),g.Region=function(a){a=a||{},this.cid=a.name||b.uniqueId("region"),this._ensureView(a)},g.Region.extend=d.View.extend,b.extend(g.Region.prototype,d.Events,{_ensureView:function(a){var b={el:a.el,tagName:"span",attributes:function(){return{"data-cid":this.cid}}};this._view=new d.View(b),this._view.$el.selector=this._view.$el.selector||"[data-cid="+this._view.cid+"]",this.view=a.view||this._view,this._assignParent(this.view)},_ensureElement:function(a){var b=f(this),c=a.$el.selector;a.setElement(b.find(c))},reset:function(a){this.attach(this._view,a)},render:function(){return this.view.render()},attach:function(a,b){var c=this.view;return e(this._detachedView,"remove"),delete this._detachedView,this._assignParent(a),c.$el.after(a.$el),c.$el.detach(),this.view=a,b||c.remove(),a},remove:function(){this.trigger("remove",this),this._removeViews(),this._removeFromParent(),this.stopListening()},_removeViews:function(){this.view.remove(),this._view.remove(),e(this._detachedView,"remove")},_removeFromParent:function(){e(this._parent,"_removeRegion",this),this._parent=null},detach:function(){var a=this.view;return a!==this._view&&(this.reset(!0),this._detachedView=a),this},reattach:function(){this._view.el||this._ensureElement(this._view);var a=f(this),b=this.view.$el.selector,c=this._detachedView||this._view;return a.find(b).replaceWith(c.$el),delete this._detachedView,this.view=c,c},_removeView:function(a){this.view===a&&this.reset(!0)},_assignParent:function(a){a._parent=this}}),g.ModelView=g.View.extend({modelEvents:{change:"render",destroy:"remove"},serialize:function(){return this.model.attributes}}),g.CollectionView=g.View.extend({constructor:function(a){this._modelViews={},this._ensureModelView(a||{}),g.View.apply(this,arguments),this.on("rendered",this._renderCollectionViews),this.on("remove",this._removeModelViews)},collectionEvents:{add:"addOne",remove:"removeOne",reset:"render",sort:"render"},render:function(){return this.once("render",this._removeModelViews()),g.CollectionView.__super__.render.apply(this)},_renderCollectionViews:function(){var a=c(document.createDocumentFragment()),b=this.appendHtml;this.appendHtml=function(b){a.append(b)},this.collection.each(this.addOne,this),this.appendHtml=b,this.appendHtml(a)},appendHtml:function(a){this.$el.append(a)},addOne:function(a){var b=new this.ModelView({model:a});return this._modelViews[b.cid]=b,b._parent=this,this.trigger("addOne",b,this),this.appendHtml(b.render().$el),this.trigger("addedOne",b,this),b},removeOne:function(a){var c=b.findWhere(this._modelViews,{model:a});return c&&(this.trigger("removeOne",c,this),c.remove(),this.trigger("removedOne",c,this)),c},_removeView:function(a){delete this._modelViews[a.cid]},_removeModelViews:function(){this.$el.empty(),b.invoke(this._modelViews,"remove")},_ensureModelView:function(a){this.ModelView=a.ModelView||this.ModelView||g.ModelView}}),g}(this,_,jQuery,Backbone);