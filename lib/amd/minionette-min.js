// Backbone.Minionette
// -------------------
// v1.3.0
//
// Copyright (c)2013 Justin Ridgewell
// Distributed under MIT license
//
// https://github.com/jridgewell/minionette

!function(a){"use strict";if("object"==typeof exports){var b=require("underscore"),c=require("jquery"),d=require("backbone");module.exports=a(b,c,d)}else"function"==typeof define&&define.amd&&define(["underscore","jquery","backbone"],a)}(function(a,b,c){"use strict";var d=function(a,b,c){function d(b,c){if(null==b)return void 0;var d=a.rest(arguments,2);return a.isFunction(b[c])?b[c].apply(b,d):void 0}function e(b){return a.result(b._parent,"$el")||c.$()}var f=c.Minionette={};return f.View=c.View.extend({constructor:function(b){b=b||{},this._ensureRegion(b),this._initializeRegions(b),c.View.apply(this,arguments),this._listenToEvents(this.model,a.result(this,"modelEvents")),this._listenToEvents(this.collection,a.result(this,"collectionEvents")),a.bindAll(this,"_viewHelper")},template:function(){return""},serialize:function(){return{}},_serialize:function(){return a.extend({view:this._viewHelper},this.serialize())},remove:function(){this.trigger("remove",this),this._removeFromParent(),a.invoke(this._regions,"remove"),f.View.__super__.remove.apply(this,arguments),this.trigger("removed",this),this.unbind()},render:function(){return this.trigger("render",this),a.invoke(this._regions,"detach"),this.$el.html(this.template(this._serialize())),a.invoke(this._regions,"reattach"),this.trigger("rendered",this),this},addRegion:function(a,b){d(this._regions[a],"remove");var c={name:a};!b||b.$el?c.view=b:(c.el=this.$(b),c.el.selector=b.selector||b);var e=new this.Region(c);return e._parent=this,this[e.cid]=this._regions[e.cid]=e,e},addRegions:function(b){a.each(b,function(a,b){this.addRegion(b,a)},this)},_removeFromParent:function(){d(this._parent,"_removeView",this)},_removeRegion:function(a){delete this[a.cid],delete this._regions[a.cid]},_listenToEvents:function(b,c){b&&a.each(c,function(c,d){a.isFunction(c)||(c=this[c]),this.listenTo(b,d,c)},this)},_ensureRegion:function(a){this.Region=a.Region||this.Region||f.Region},_initializeRegions:function(b){this._regions={};var c=a.result(b,"regions")||a.result(this,"regions");this.addRegions(c)},_viewHelper:function(a){var b=this._regions[a];return b&&b.render().el?b.view.el.outerHTML:""}}),f.Region=function(b){b=b||{},this.cid=b.name||a.uniqueId("region"),this._ensureView(b)},f.Region.extend=c.View.extend,a.extend(f.Region.prototype,c.Events,{_ensureView:function(a){var b={el:a.el,tagName:"span",attributes:function(){return{"data-cid":this.cid}}};this._view=new c.View(b),this._view.$el.selector=this._view.$el.selector||"[data-cid="+this._view.cid+"]",this.view=a.view||this._view,this.view._parent=this},_ensureElement:function(a){var b=e(this),c=a.$el.selector;a.setElement(b.find(c))},reset:function(a){this.attach(this._view,a)},render:function(){return this.view.render()},attach:function(a,b){var c=this.view;if(a!==c)return d(this._detachedView,"remove"),delete this._detachedView,c.$el.parent().length&&(c.$el.after(a.$el),c.$el.detach()),this.view=a,a._parent=this,b||c.remove(),a},remove:function(){this.trigger("remove",this),this._removeViews(),this._removeFromParent(),this.stopListening()},_removeViews:function(){this.view.remove(),this._view.remove(),d(this._detachedView,"remove")},_removeFromParent:function(){d(this._parent,"_removeRegion",this),this._parent=null},detach:function(){var a=this.view;return a!==this._view&&(this.reset(!0),this._detachedView=a),this},reattach:function(){if(this._view.el||this._ensureElement(this._view),this._detachedView||this.view===this._view){var a=e(this),b=this.view.$el.selector,c=a.find(b),d=this._detachedView||this._view;if(c[0]!==d.$el[0])return c.replaceWith(d.$el),delete this._detachedView,this.view=d,d}},_removeView:function(a){this.view===a&&this.reset(!0)}}),f.ModelView=f.View.extend({modelEvents:{change:"render",destroy:"remove"},serialize:function(){return this.model.attributes}}),f.CollectionView=f.View.extend({constructor:function(a){this._modelViews={},this._ensureModelView(a||{}),f.View.apply(this,arguments),this.on("rendered",this._renderCollectionViews),this.on("remove",this._removeModelViews)},collectionEvents:{add:"addOne",remove:"removeOne",reset:"render",sort:"render"},render:function(){return this.once("render",this._removeModelViews()),f.CollectionView.__super__.render.apply(this)},_renderCollectionViews:function(){var a=document.createDocumentFragment(),b=this.appendHtml;this.appendHtml=function(b){a.appendChild(b[0])},this.collection.each(this.addOne,this),this.appendHtml=b,this.appendHtml(a)},appendHtml:function(a){this.$el.append(a)},addOne:function(a){var b=new this.ModelView({model:a});return this._modelViews[b.cid]=b,b._parent=this,this.trigger("addOne",b,this),this.appendHtml(b.render().$el),this.trigger("addedOne",b,this),b},removeOne:function(b){var c=a.findWhere(this._modelViews,{model:b});return c&&(this.trigger("removeOne",c,this),c.remove(),this.trigger("removedOne",c,this)),c},_removeView:function(a){delete this._modelViews[a.cid]},_removeModelViews:function(){this.$el.empty(),a.invoke(this._modelViews,"remove")},_ensureModelView:function(a){this.ModelView=a.ModelView||this.ModelView||f.ModelView}}),f}(a,b,c);return d});